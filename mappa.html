<!DOCTYPE html>
<html>
	<head>
	  <!-- This stylesheet contains specific styles for displaying the map
		on this page. Replace it with your own styles as described in the
		documentation:
		https://developers.google.com/maps/documentation/javascript/tutorial -->
	<!--     <link rel="stylesheet" href="/maps/documentation/javascript/demos/demos.css"> -->
	<script src="https://www.google.com/jsapi"></script>

	</head>
	<body>

	<h1>Map title</h1>

	<div id="map_div" style="width:100%;height:400px;"></div>    
	<div id="elevation_chart_div" style="width: 100%;height:400px;"></div>

	<script>

	function getParameter(whichOne)
	{
		var pairs = location.search.substring(1).split('&');
		var r = "";
		var tp = new Array();

		for (var i = 0; i < pairs.length; i ++)
		{
			tp = pairs[i].split('=');

			if (whichOne == tp[0])
			{
				r = unescape(tp[1].replace(/\+/g, " "));
			}
		}

		return r;
	} 

// 	console.log(getParameter("mappa"));

	// Load the Visualization API and the columnchart package.
// 	google.load('visualization', '1', {packages: ['columnchart']});
 google.load("visualization", "1", {packages:["corechart"]});
 
	var map;
	var elevator_service;
	var distance_matrix_service;
	var data;
	var chart;
	var marker_select;

	function init_map()
	{
		map = new google.maps.Map(document.getElementById("map_div"), {mapTypeId:google.maps.MapTypeId.HYBRID});
		map.data.loadGeoJson('http://michelesanges.github.io/dataset/' + getParameter("mappa"), {}, draw_map);

// global infowindow
// When the user clicks, open an infowindow
// map.data.addListener('click', function(event)
// {
// var myHTML = event.feature.getProperty("name");
// console.log("myHTML="+myHTML);
// infowindow.setContent("<div style='width:150px; text-align: center;'>"+myHTML+"</div>");
// infowindow.setPosition(event.feature.getGeometry().getAt(0));
// infowindow.setOptions({pixelOffset: new google.maps.Size(0,30)});
// infowindow.open(map);
// });  
	}


	function draw_map(featarr)
	{
		for (var i = 0; i < featarr.length; i++)
		{
console.log("inside draw_map callback: "+ featarr[i].getGeometry().getType() + " - i = " +i);

			if (featarr[i].getGeometry().getType() == "LineString") 
			{
				console.log("len: " + featarr[i].getGeometry().getLength());	

				// marker a inizio e fine percorso
				// featarr[i].getGeometry().forEachLatLng(set_marker);
				if (featarr[i].getGeometry().getLength() > 0)
				{
					var bounds = new google.maps.LatLngBounds();

					var position = featarr[i].getGeometry().getAt(0);

					bounds.extend(position); //do this for each coordinate

					var marker_start = new google.maps.Marker({position, map: map, animation: google.maps.Animation.DROP, 
					icon: 'http://michelesanges.github.io/img/bike_start.png', label:"Start"});

					position = featarr[i].getGeometry().getAt(featarr[i].getGeometry().getLength() - 1);
					bounds.extend(position);

					var marker_stop = new google.maps.Marker({position, map: map, animation: google.maps.Animation.DROP, 
					icon: 'http://michelesanges.github.io/img/bike_stop.png', label:"Stop"});

					map.fitBounds(bounds);
					map.setCenter(bounds.getCenter());

					// Draw the path, using the Visualization API and the Elevation service.
					display_path_elevation(featarr[i].getGeometry().getArray(), map);

					// path lenght
					polyLengthInMeters = google.maps.geometry.spherical.computeLength(featarr[i].getGeometry().getArray());
					polyLengthInMeters = polyLengthInMeters/1000;
					
					var info_window = new google.maps.InfoWindow();
					info_window.setPosition(position);
					info_window.setContent("Distance: " + polyLengthInMeters.toFixed(1) + " [km]");
					info_window.open(map);
				}

			}
		}

	}


	function display_path_elevation(path, map)
	{
		elevator_service = new google.maps.ElevationService;

		// Display a polyline of the elevation path.
		new google.maps.Polyline
		({
			path: path,
			strokeColor: '#0000CC',
			strokeOpacity: 0.4,
			strokeWeight: 5,
			map: map
		});

		// Create a PathElevationRequest object using this array.
		// Ask for 256 samples along that path.
		// Initiate the path request.
		elevator_service.getElevationAlongPath
		({
			'path': path,
			'samples': 512
		}, plot_elevation);
	}


	// Takes an array of ElevationResult objects, draws the path on the map
	// and plots the elevation profile on a Visualization API ColumnChart.
	function plot_elevation(elevations, status)
	{
console.log("elevations status=" + status);
console.log("elevations.length=" + elevations.length);

		if (status == 'OK')
		{
			// Create a new chart in the elevation_chart_div DIV.
			chart = new google.visualization.ColumnChart(document.getElementById('elevation_chart_div'));
			google.visualization.events.addListener(chart, 'select', select_handler);

			// Extract the data from which to populate the chart.
			// Because the samples are equidistant, the 'Sample'
			// column here does double duty as distance along the
			// X axis.
			data = new google.visualization.DataTable();
			data.addColumn('string', 'Sample');
			data.addColumn('number', 'Elevation');
			data.addColumn('number', 'Latitude');
			data.addColumn('number', 'Longitude');
			data.addColumn({type:'string',role:'tooltip'});

			for (var i = 0; i < elevations.length; i++)
			{
				data.addRow(['', elevations[i].elevation,  elevations[i].location.lat(), elevations[i].location.lng(),
				"Elev: " + elevations[i].elevation + " [m]\n" + "Pos: " + elevations[i].location]);
			}

			chart.draw(data, {
			height: 400,
			legend: 'none',
 			title: 'Path elevation',
			titleX: 'Distance [Km]',
			titleY: 'Elevation [m]',
			hAxis:{maxValue:550}
			});
			
		}
	}
	
	function select_handler(e)
	{  
		var selectedItem = chart.getSelection()[0];
		if (selectedItem)
		{
			var lat = data.getValue(selectedItem.row, 2/*selectedItem.column*/);
			var lon = data.getValue(selectedItem.row, 3/*selectedItem.column*/);
			console.log("value=" + lat+ lon);

		}
	  
		var position = new google.maps.LatLng(lat, lon);

		if (marker_select == undefined)
		{
			marker_select = new google.maps.Marker({
			position: position,
			map: map, 
			animation: google.maps.Animation.DROP,
			});
		}
		else
		{
			marker_select.setPosition(position);
		}	  
	}

	</script>

	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwR5MtCCmXualVOiq27XnxxosJhitng-k&callback=init_map&libraries=geometry"></script>
	<!--
	To use this code on your website, get a free API key from Google.
	Read more at: https://www.w3schools.com/graphics/google_maps_basic.asp
	-->

	</body>
</html>
